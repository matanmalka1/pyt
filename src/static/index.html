<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PlantVillage AI</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;1,9..144,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="shell">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div>
    <div class="logo">PlantVillage<span>🌿 AI</span></div>
  </div>
  <nav style="display:flex;flex-direction:column;gap:.4rem">
    <div class="nav-item active" data-page="train"><span class="nav-dot"></span>אימון</div>
    <div class="nav-item" data-page="predict"><span class="nav-dot"></span>זיהוי מחלה</div>
    <div class="nav-item" data-page="results"><span class="nav-dot"></span>תוצאות</div>
    <div class="nav-item" data-page="history"><span class="nav-dot"></span>היסטוריה</div>
  </nav>
  <div class="sidebar-status">
    <div class="status-label">סטטוס מודל</div>
    <div class="status-val" id="model-status">לא מאומן</div>
    <div class="status-label" style="margin-top:.75rem">Best Val Acc</div>
    <div class="status-val good" id="best-acc-side">—</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- ══ TRAIN PAGE ══ -->
  <div class="page active" id="page-train">
    <div class="page-header">
      <div class="page-title">אימון המודל</div>
      <div class="page-sub">הגדר פרמטרים והרץ את pipeline האימון</div>
    </div>
    <div class="card">
      <div class="card-title">פרמטרים</div>
      <div class="form-grid">
        <div class="field">
          <label>Backbone</label>
          <select id="backbone">
            <option value="resnet18" selected>ResNet18 — מהיר</option>
            <option value="resnet34">ResNet34 — מאוזן</option>
            <option value="resnet50">ResNet50 — דיוק מקסימלי</option>
          </select>
        </div>
        <div class="field"><label>Epochs</label><input type="number" id="epochs" value="5" min="1" max="50"/></div>
        <div class="field"><label>Batch Size</label><input type="number" id="batch" value="64" min="8" max="256"/></div>
        <div class="field"><label>Learning Rate</label><input type="number" id="lr" value="0.001" step="0.0001" min="0.00001"/></div>
      </div>
      <div style="margin-top:1.25rem;display:flex;gap:.75rem;align-items:center">
        <button class="btn btn-primary" id="btn-train" onclick="startTraining()">הרץ אימון</button>
        <button class="btn btn-ghost" onclick="resetLog()">נקה לוג</button>
        <span id="train-spinner" class="hidden"><span class="spinner"></span></span>
      </div>
    </div>
    <div class="card" id="progress-card" style="display:none">
      <div class="card-title">התקדמות</div>
      <div class="epoch-progress">
        <div class="ep-row"><div class="ep-label">Epoch</div><div class="ep-bar-wrap"><div class="ep-bar" id="bar-epoch"></div></div><div class="ep-val" id="val-epoch">0 / 0</div></div>
        <div class="ep-row"><div class="ep-label">Train Acc</div><div class="ep-bar-wrap"><div class="ep-bar" id="bar-tacc"></div></div><div class="ep-val" id="val-tacc">—</div></div>
        <div class="ep-row"><div class="ep-label">Val Acc</div><div class="ep-bar-wrap"><div class="ep-bar" id="bar-vacc"></div></div><div class="ep-val" id="val-vacc">—</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">לוג</div>
      <div class="log-box" id="log-box"><div class="log-line" style="color:var(--muted)">ממתין להרצה...</div></div>
    </div>
  </div>

  <!-- ══ PREDICT PAGE ══ -->
  <div class="page hidden" id="page-predict">
    <div class="page-header">
      <div class="page-title">זיהוי מחלה</div>
      <div class="page-sub">העלה תמונת עלה וקבל תחזית מהמודל המאומן</div>
    </div>

    <div class="card">
      <div class="card-title">העלאת תמונה</div>

      <!-- Upload zone (shown when no image) -->
      <div class="upload-zone" id="upload-zone"
           ondragover="event.preventDefault();this.classList.add('drag')"
           ondragleave="this.classList.remove('drag')"
           ondrop="handleDrop(event)">
        <input type="file" id="file-input" accept="image/*" onchange="handleFile(this.files[0])"/>
        <div class="upload-icon">🌿</div>
        <div class="upload-text">גרור תמונה או לחץ לבחירה</div>
        <div class="upload-hint">JPG, PNG, WEBP — עד 10MB</div>
      </div>

      <!-- [NEW] Preview (shown after picking image, before predict result) -->
      <div id="preview-section" class="hidden" style="text-align:center;padding:1rem 0">
        <div class="preview-wrap">
          <img id="preview-img" class="preview-img-thumb" src="" alt="preview"/>
          <button class="btn-clear" onclick="clearImage()" title="הסר תמונה">✕</button>
        </div>
        <div style="font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);margin-bottom:.75rem" id="preview-filename"></div>
        <button class="btn btn-primary" onclick="runPredict()">נתח תמונה</button>
      </div>
    </div>

    <div class="card hidden" id="predict-result-card">
      <div class="card-title">תחזית</div>
      <div id="predict-loading" class="hidden" style="text-align:center;padding:2rem;color:var(--muted);font-family:'DM Mono',monospace;font-size:.8rem">
        מנתח תמונה<span class="spinner"></span>
      </div>
      <div class="hidden" id="predict-result">
        <!-- Health badge -->
        <div id="health-badge"></div>
        <div class="predict-result">
          <img id="predict-img" class="predict-img" src="" alt="leaf"/>
          <div class="predictions" id="predictions"></div>
        </div>
        <!-- Grad-CAM section -->
        <div class="gradcam-wrap" id="gradcam-wrap" style="display:none">
          <div class="gradcam-col">
            <div class="gradcam-label">תמונה מקורית</div>
            <img id="gradcam-orig" class="gradcam-img" src="" alt="original"/>
          </div>
          <div class="gradcam-col">
            <div class="gradcam-label">Grad-CAM — אזורי השפעה</div>
            <img id="gradcam-heat" class="gradcam-img" src="" alt="heatmap"/>
            <div class="gradcam-legend">
              <div class="gradcam-legend-bar"></div>
              <div class="gradcam-legend-labels"><span>נמוך</span><span>גבוה</span></div>
            </div>
          </div>
        </div>
        <div id="gradcam-error" class="gradcam-error hidden">Grad-CAM לא זמין</div>
      </div>
    </div>
  </div>

  <!-- ══ RESULTS PAGE ══ -->
  <div class="page hidden" id="page-results">
    <div class="page-header">
      <div class="page-title">תוצאות אימון</div>
      <div class="page-sub">ביצועים ועקומות לאורך ה-epochs</div>
    </div>
    <div class="stats-row" id="stats-row">
      <div class="stat-card"><div class="stat-num" id="s-best-acc">—</div><div class="stat-lbl">Best Val Acc</div></div>
      <div class="stat-card"><div class="stat-num" id="s-test-acc">—</div><div class="stat-lbl">Test Acc</div></div>
      <div class="stat-card"><div class="stat-num" id="s-epochs">—</div><div class="stat-lbl">Epochs</div></div>
      <div class="stat-card"><div class="stat-num" id="s-backbone">—</div><div class="stat-lbl">Backbone</div></div>
    </div>

    <!-- [NEW] Export + Model Comparison -->
    <div class="card">
      <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
        <span>השוואת מודלים</span>
        <button class="btn btn-ghost" style="font-size:.7rem;padding:.4rem .9rem" onclick="exportCSV()">⬇ ייצוא CSV</button>
      </div>
      <table class="compare-table" id="compare-table">
        <thead>
          <tr>
            <th>Backbone</th>
            <th>Val Acc</th>
            <th>Test Acc</th>
            <th>Epochs</th>
            <th>ויזואל</th>
          </tr>
        </thead>
        <tbody id="compare-tbody">
          <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:1.5rem">אין נתוני אימון עדיין</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-title">Loss</div>
      <div class="chart-wrap"><canvas id="chart-loss"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Accuracy</div>
      <div class="chart-wrap"><canvas id="chart-acc"></canvas></div>
    </div>
  </div>

  <!-- ══ [NEW] HISTORY PAGE ══ -->
  <div class="page hidden" id="page-history">
    <div class="page-header">
      <div class="page-title">היסטוריית תחזיות</div>
      <div class="page-sub">כל התמונות שנותחו בסשן הנוכחי</div>
    </div>
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem">
      <span style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--muted)" id="history-count">0 תחזיות</span>
      <button class="btn btn-ghost" style="font-size:.7rem;padding:.4rem .9rem" onclick="clearHistory()">נקה הכל</button>
    </div>
    <div class="card">
      <div class="history-list" id="history-list">
        <div class="history-empty">עדיין לא נותחו תמונות</div>
      </div>
    </div>
  </div>

</main>
</div>

<script src="app.js"></script>
</body>
</html>
